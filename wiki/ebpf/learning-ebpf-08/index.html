
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 8.0.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>eBPF：08. eBPF for Networking - gaoyangu</title>

  
    <meta name="description" content="8.1 Packet DropsThere are several network security features that involve dropping certain incoming packets and allowing others.   firewalling DDoS protection packet-of-death vulnerabilities an eBPF pr">
<meta property="og:type" content="website">
<meta property="og:title" content="08. eBPF for Networking">
<meta property="og:url" content="http://example.com/wiki/ebpf/learning-ebpf-08/">
<meta property="og:site_name" content="gaoyangu">
<meta property="og:description" content="8.1 Packet DropsThere are several network security features that involve dropping certain incoming packets and allowing others.   firewalling DDoS protection packet-of-death vulnerabilities an eBPF pr">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/notion-avatar-1764230194071.png">
<meta property="article:published_time" content="2025-11-27T08:06:23.131Z">
<meta property="article:modified_time" content="2025-11-27T08:06:23.131Z">
<meta property="article:author" content="gaoyangu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/notion-avatar-1764230194071.png">
  
  
  
  

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Website","@id":"http://example.com/wiki/ebpf/learning-ebpf-08/","author":{"@type":"Person","name":"gaoyangu","sameAs":[],"image":"/images/notion-avatar-1764230194071.png"},"name":"08. eBPF for Networking","description":"8.1 Packet DropsThere are several network security features that involve dropping certain incoming packets and allowing others. \n\nfirewalling\nDDoS protection\npacket-of-death vulnerabilities\nan eBPF...","url":"http://example.com/wiki/ebpf/learning-ebpf-08/"}</script>
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@700&display=swap" rel="stylesheet">
</head>
<body>



<div class="l_body content" id="start" layout="page" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="https://raw.githubusercontent.com/gaoyangu/blog_pic/main/icon/bee.svg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/wiki/ebpf/ebpf"><div class="main">eBPF</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item active" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="探索" href="/explore/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/ebpf/" placeholder="在 ebpf 中搜索..."></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<widget class="widget-wrapper doc-tree post-list"><div class="widget-header dis-select"><span class="name">导航</span></div><div class="widget-body fs14"><a class="link" href="/wiki/ebpf/ebpf/#start"><span class="toc-text">index</span></a><a class="link" href="/wiki/ebpf/ebpf-install/"><span class="toc-text">WSL2 安装 BPF 工具链</span></a><a class="link" href="/wiki/ebpf/ebpf-timeline/"><span class="toc-text">时间线</span></a></div><div class="widget-header dis-select"><span class="name">工具</span></div><div class="widget-body fs14"><a class="link" href="/wiki/ebpf/linux-ebpf-file/"><span class="toc-text">some file about ebpf</span></a><a class="link" href="/wiki/ebpf/bpftool/"><span class="toc-text">bpftool</span></a><a class="link" href="/wiki/ebpf/bpftrace/"><span class="toc-text">bpftrace</span></a><a class="link" href="/wiki/ebpf/sections/"><span class="toc-text">c语言内存分区</span></a></div><div class="widget-header dis-select"><span class="name">Learining eBPF</span></div><div class="widget-body fs14"><a class="link" href="/wiki/ebpf/learning-ebpf-00/"><span class="toc-text">00. Running the example code</span></a><a class="link" href="/wiki/ebpf/learning-ebpf-01/"><span class="toc-text">01. What Is eBPF, and Why Is It Important?</span></a><a class="link" href="/wiki/ebpf/learning-ebpf-02/"><span class="toc-text">02. eBPF’s “Hello World”</span></a><a class="link" href="/wiki/ebpf/learning-ebpf-03/"><span class="toc-text">03. Anatomy of an eBPF Program</span></a><a class="link" href="/wiki/ebpf/learning-ebpf-04/"><span class="toc-text">04. The bpf() System Call</span></a><a class="link" href="/wiki/ebpf/learning-ebpf-05/"><span class="toc-text">05. CO-RE, BTF, and Libbpf</span></a><a class="link" href="/wiki/ebpf/learning-ebpf-06/"><span class="toc-text">06. The eBPF Veriier</span></a><a class="link" href="/wiki/ebpf/learning-ebpf-07/"><span class="toc-text">07. eBPF Program and Attachment Types</span></a><a class="link active" href="/wiki/ebpf/learning-ebpf-08/"><span class="toc-text">08. eBPF for Networking</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="link" href="/wiki/ebpf/learning-ebpf-09/"><span class="toc-text">09. eBPF for Security</span></a><a class="link" href="/wiki/ebpf/learning-ebpf-10/"><span class="toc-text">10. eBPF Programming</span></a></div><div class="widget-header dis-select"><span class="name">libbpf-bootstrap</span></div><div class="widget-body fs14"><a class="link" href="/wiki/ebpf/libbpf-bootstrap-00/"><span class="toc-text">env</span></a><a class="link" href="/wiki/ebpf/libbpf-bootstrap-01/"><span class="toc-text">minimal</span></a><a class="link" href="/wiki/ebpf/libbpf-bootstrap-02/"><span class="toc-text">minimal_ns</span></a><a class="link" href="/wiki/ebpf/libbpf-bootstrap-03/"><span class="toc-text">minimal_Legacy</span></a><a class="link" href="/wiki/ebpf/libbpf-bootstrap-04/"><span class="toc-text">bootstrap</span></a></div></widget>

<widget class="widget-wrapper post-card"><div class="widget-header dis-select"><span class="name">更多：编程</span></div><div class="widget-body"><a class="item wiki" href="/wiki/cpp/"><span class="title">code</span></a><a class="item wiki" href="/wiki/linux_tool/git/"><span class="title">Linux Tool</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki/">文档</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/ebpf/ebpf/">eBPF</a></div>
<div class="flex-row" id="post-meta"><span class="text created">更新于：<time datetime="2025-11-27T08:06:23.131Z">2025-11-27</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>08. eBPF for Networking</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h2 id="8-1-Packet-Drops"><a href="#8-1-Packet-Drops" class="headerlink" title="8.1 Packet Drops"></a>8.1 Packet Drops</h2><p>There are several network security features that involve dropping certain incoming packets and allowing others. </p>
<ul>
<li>firewalling</li>
<li>DDoS protection</li>
<li>packet-of-death vulnerabilities<ul>
<li>an eBPF program that detects and drops these malicious packets can be installed dynamically, instantly protecting that host without affecting any applications running on the machine.</li>
</ul>
</li>
</ul>
<h3 id="8-1-1-XDP-Program-Return-Codes"><a href="#8-1-1-XDP-Program-Return-Codes" class="headerlink" title="8.1.1 XDP Program Return Codes"></a>8.1.1 XDP Program Return Codes</h3><p>An XDP program is triggered by the arrival of a network packet. the return code gives a verdict that indicates what to do next with that packet:</p>
<ul>
<li>XDP_PASS<ul>
<li>the packet should be sent to the network stack in the normal way</li>
</ul>
</li>
<li>XDP_DROP<ul>
<li>the packet to be discarded immediately</li>
</ul>
</li>
<li>XDP_TX<ul>
<li>sends the packet back out of the same interface it arrived on</li>
</ul>
</li>
<li>XDP_REDIRECT<ul>
<li>send it to a different network interface</li>
</ul>
</li>
<li>XDP_ABORTED<ul>
<li>the packet being dropped, but its use implies an error case or something unexpected, rather than a “normal” decision to discard a packet.</li>
</ul>
</li>
</ul>
<p>An outline for an XDP program that decides whether to drop packets looks something like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">&quot;xdp&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">hello</span><span class="params">(<span class="keyword">struct</span> xdp_md *ctx)</span> &#123;</span><br><span class="line">    <span class="type">bool</span> drop;</span><br><span class="line">    drop = &lt;examine packet and decide whether to drop it&gt;;</span><br><span class="line">    <span class="keyword">if</span> (drop)</span><br><span class="line">        <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XDP programs get triggered whenever an inbound network packet arrives on the interface to which it is attached.</p>
<p>The <code>ctx</code> parameter is a pointer to an <code>xdp_md</code> structure, which holds metadata about the incoming packet.</p>
<h3 id="8-1-2-XDP-Packet-Parsing"><a href="#8-1-2-XDP-Packet-Parsing" class="headerlink" title="8.1.2 XDP Packet Parsing"></a>8.1.2 XDP Packet Parsing</h3><p>the definition of the <code>xdp_md</code> structure</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xdp_md</span> &#123;</span></span><br><span class="line">    __u32 data;</span><br><span class="line">    __u32 data_end;</span><br><span class="line">    __u32 data_meta;</span><br><span class="line">    <span class="comment">/* Below access go through struct xdp_rxq_info */</span></span><br><span class="line">    __u32 ingress_ifindex; <span class="comment">/* rxq-&gt;dev-&gt;ifindex */</span></span><br><span class="line">    __u32 rx_queue_index; <span class="comment">/* rxq-&gt;queue_index */</span></span><br><span class="line">    __u32 egress_ifindex; <span class="comment">/* txq-&gt;dev-&gt;ifindex */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>they are really pointers.</p>
<p>The <code>data</code> field indicates the location in memory where the packet starts, and <code>data_end</code> shows where it ends. </p>
<p><code>data_meta</code> can be used for coordination between multiple eBPF programs that might process the same packet at various places on its journey through the stack.</p>
<h4 id="hello-ping"><a href="#hello-ping" class="headerlink" title="hello ping"></a>hello ping</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">&quot;xdp&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">ping</span><span class="params">(<span class="keyword">struct</span> xdp_md *ctx)</span> &#123;</span><br><span class="line">    <span class="type">long</span> protocol = lookup_protocol(ctx);</span><br><span class="line">    <span class="keyword">if</span> (protocol == <span class="number">1</span>) <span class="comment">// ICMP</span></span><br><span class="line">    &#123;</span><br><span class="line">        bpf_printk(<span class="string">&quot;Hello ping&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> learning-ebpf/chapter8</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">ping localhost</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /sys/kernel/tracing/trace_pipe</span><br></pre></td></tr></table></figure>

<p>There are two lines of trace per second because the loopback interface is receiving both the ping requests and the ping responses.</p>
<p>The network packet that has been received consists of a string of bytes.</p>
<p><img src="https://binw666.github.io/learning-ebpf-translation/08-%E7%94%A8%E4%BA%8E%E7%BD%91%E7%BB%9C%E7%9A%84eBPF/figure-8-1.jpg"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Returns the protocol byte for an IP packet, 0 for anything else</span></span><br><span class="line"><span class="comment">// static __always_inline unsigned char lookup_protocol(struct xdp_md *ctx)</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">lookup_protocol</span><span class="params">(<span class="keyword">struct</span> xdp_md *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> protocol = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *data = (<span class="type">void</span> *)(<span class="type">long</span>)ctx-&gt;data;</span><br><span class="line">    <span class="type">void</span> *data_end = (<span class="type">void</span> *)(<span class="type">long</span>)ctx-&gt;data_end;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> =</span> data;</span><br><span class="line">    <span class="keyword">if</span> (data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr) &gt; data_end)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check that it&#x27;s an IP packet</span></span><br><span class="line">    <span class="keyword">if</span> (bpf_ntohs(eth-&gt;h_proto) == ETH_P_IP)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Return the protocol of this packet</span></span><br><span class="line">        <span class="comment">// 1 = ICMP</span></span><br><span class="line">        <span class="comment">// 6 = TCP</span></span><br><span class="line">        <span class="comment">// 17 = UDP        </span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> =</span> data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr);</span><br><span class="line">        <span class="keyword">if</span> (data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iphdr) &lt;= data_end)</span><br><span class="line">            protocol = iph-&gt;protocol;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> protocol;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>bpf_ntohs()</code> function used by this program ensures that the two bytes are in the order expected on this host.</p>
<p>You should use this function whenever you extract a value from a field in a network packet that’s more than one byte long.</p>
<h2 id="8-2-Load-Balancing-and-Forwarding"><a href="#8-2-Load-Balancing-and-Forwarding" class="headerlink" title="8.2 Load Balancing and Forwarding"></a>8.2 Load Balancing and Forwarding</h2><p>XDP programs aren’t limited to inspecting the contents of a packet. They can also modify the packet’s contents.</p>
<p>the load balancer receives traffic from the client and forwards it to one of the two backend containers.</p>
<p><img src="https://binw666.github.io/learning-ebpf-translation/08-%E7%94%A8%E4%BA%8E%E7%BD%91%E7%BB%9C%E7%9A%84eBPF/figure-8-2.jpg"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">&quot;xdp_lb&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">xdp_load_balancer</span><span class="params">(<span class="keyword">struct</span> xdp_md *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 该函数的第一部分实际上与前面的示例相同：它定位数据包中的以太网报头，然后定位 IP 报头。</span></span><br><span class="line">    <span class="type">void</span> *data = (<span class="type">void</span> *)(<span class="type">long</span>)ctx-&gt;data;</span><br><span class="line">    <span class="type">void</span> *data_end = (<span class="type">void</span> *)(<span class="type">long</span>)ctx-&gt;data_end;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> =</span> data;</span><br><span class="line">    <span class="keyword">if</span> (data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr) &gt; data_end)</span><br><span class="line">        <span class="keyword">return</span> XDP_ABORTED;</span><br><span class="line">    <span class="keyword">if</span> (bpf_ntohs(eth-&gt;h_proto) != ETH_P_IP)</span><br><span class="line">        <span class="keyword">return</span> XDP_PASS;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> =</span> data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr);</span><br><span class="line">    <span class="keyword">if</span> (data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iphdr) &gt; data_end)</span><br><span class="line">        <span class="keyword">return</span> XDP_ABORTED;</span><br><span class="line">    <span class="comment">// 这次它将只处理 TCP 数据包，将收到的任何其他数据包传递给网络协议栈，就好像什么也没发生一样。</span></span><br><span class="line">    <span class="keyword">if</span> (iph-&gt;protocol != IPPROTO_TCP)</span><br><span class="line">        <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">    <span class="comment">// 这里要检查源 IP 地址。如果该数据包不是来自客户端，我就认为它是发给客户端的响应。</span></span><br><span class="line">    <span class="keyword">if</span> (iph-&gt;saddr == IP_ADDRESS(CLIENT))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 此代码在后端 A 和 B 之间生成伪随机选择。</span></span><br><span class="line">        <span class="type">char</span> be = BACKEND_A;</span><br><span class="line">        <span class="keyword">if</span> (bpf_get_prandom_u32() % <span class="number">2</span>)</span><br><span class="line">            be = BACKEND_B;</span><br><span class="line">        <span class="comment">// 更新目标 IP 和 MAC 地址，以匹配所选的后端...</span></span><br><span class="line">        iph-&gt;daddr = IP_ADDRESS(be);</span><br><span class="line">        eth-&gt;h_dest[<span class="number">5</span>] = be;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ......或者，如果这是来自后端的响应（如果不是来自客户端，这里就是假设），则会更新目标 IP 和 MAC 地址以匹配客户端。</span></span><br><span class="line">        iph-&gt;daddr = IP_ADDRESS(CLIENT);</span><br><span class="line">        eth-&gt;h_dest[<span class="number">5</span>] = CLIENT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 无论该数据包流向何处，都需要更新源地址，以便该数据包看起来像是源自负载均衡器。</span></span><br><span class="line">    iph-&gt;saddr = IP_ADDRESS(LB);</span><br><span class="line">    eth-&gt;h_source[<span class="number">5</span>] = LB;</span><br><span class="line">    iph-&gt;check = iph_csum(iph);</span><br><span class="line">    <span class="keyword">return</span> XDP_TX;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-3-XDP-Offloading"><a href="#8-3-XDP-Offloading" class="headerlink" title="8.3 XDP Offloading"></a>8.3 XDP Offloading</h2><p>There are some network interface cards that support this full XDP offload capability where they can indeed run eBPF programs on inbound packets on their own processor. </p>
<p><img src="https://binw666.github.io/learning-ebpf-translation/08-%E7%94%A8%E4%BA%8E%E7%BD%91%E7%BB%9C%E7%9A%84eBPF/figure-8-3.jpg"></p>
<h2 id="8-4-Traic-Control-TC"><a href="#8-4-Traic-Control-TC" class="headerlink" title="8.4 Traic Control (TC)"></a>8.4 Traic Control (TC)</h2><p>By the time a network packet reaches this point it will be in kernel memory in the form of an <code>sk_buff</code>.</p>
<p>eBPF programs attached within the TC subsystem receive a pointer to the <code>sk_buff</code> structure as the context parameter.</p>
<p>The TC subsystem is intended to regulate how network traffic is scheduled.</p>
<p>A given piece of network data in the stack flows in one of two directions:  ingress (inbound from the network interface) or egress (outbound toward the network interface). </p>
<p>eBPF programs can be attached in either direction and will affect traffic only in that direction.</p>
<p>Traditional traffic control:</p>
<ol>
<li>classifers: classify packets based on some rule</li>
<li>separate actions: based on the output from a classifier and determine what to do with a packet</li>
</ol>
<p>There can be a series of classifiers, all defined as part of a <code>qdisc</code> or queuing discipline.</p>
<p>The action is indicated by the program’s return code (whose values are defined in <code>linux/pkt_cls.h</code>):</p>
<ul>
<li>TC_ACT_SHOT: tells the kernel to drop the packet</li>
<li>TC_ACT_UNSPEC: if the eBPF program hadn’t been run on this packet</li>
<li>TC_ACT_OK: tells the kernel to pass the packet to the next layer in the stack.</li>
<li>TC_ACT_REDIRECT: sends the packet to the ingress or egress path of a different network device</li>
</ul>
<p>The first simply generates a line of trace and then tells the kernel to drop the packet:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tc_drop</span><span class="params">(<span class="keyword">struct</span> __sk_buff *skb)</span> &#123;</span><br><span class="line">    bpf_trace_printk(<span class="string">&quot;[tc] dropping packet\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> TC_ACT_SHOT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This example drops ICMP (ping) request packets:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tc</span><span class="params">(<span class="keyword">struct</span> __sk_buff *skb)</span> &#123;</span><br><span class="line">    <span class="type">void</span> *data = (<span class="type">void</span> *)(<span class="type">long</span>)skb-&gt;data;</span><br><span class="line">    <span class="type">void</span> *data_end = (<span class="type">void</span> *)(<span class="type">long</span>)skb-&gt;data_end;</span><br><span class="line">    <span class="keyword">if</span> (is_icmp_ping_request(data, data_end)) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> =</span> data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">icmphdr</span> *<span class="title">icmp</span> =</span> data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iphdr);</span><br><span class="line">        bpf_trace_printk(<span class="string">&quot;[tc] ICMP request for %x type %x\n&quot;</span>, iph-&gt;daddr, icmp-&gt;type);</span><br><span class="line">        <span class="keyword">return</span> TC_ACT_SHOT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TC_ACT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>why you would want to implement something like this at the TC layer</p>
<ol>
<li>you can use TC programs for egress traffic, where XDP can only process ingress traffic.</li>
<li>If the eBPF program is interested in or wants to manipulate the <code>sk_buff</code> the kernel creates for this packet, the TC attachment point is suitable.</li>
</ol>
<p>This example identifies a ping request being received and responds with a ping response:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tc_pingpong</span><span class="params">(<span class="keyword">struct</span> __sk_buff *skb)</span> &#123;</span><br><span class="line">    <span class="type">void</span> *data = (<span class="type">void</span> *)(<span class="type">long</span>)skb-&gt;data;</span><br><span class="line">    <span class="type">void</span> *data_end = (<span class="type">void</span> *)(<span class="type">long</span>)skb-&gt;data_end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!is_icmp_ping_request(data, data_end)) &#123;</span><br><span class="line">        <span class="keyword">return</span> TC_ACT_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> =</span> data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmphdr</span> *<span class="title">icmp</span> =</span> data + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ethhdr) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iphdr);</span><br><span class="line">    swap_mac_addresses(skb);</span><br><span class="line">    swap_ip_addresses(skb);</span><br><span class="line"></span><br><span class="line">    update_icmp_type(skb, <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    bpf_clone_redirect(skb, skb-&gt;ifindex, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> TC_ACT_SHOT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-5-Packet-Encryption-and-Decryption"><a href="#8-5-Packet-Encryption-and-Decryption" class="headerlink" title="8.5 Packet Encryption and Decryption"></a>8.5 Packet Encryption and Decryption</h2><p>In many cases an application will encrypt data using a library like OpenSSL or BoringSSL that lives in user space. If you want to trace out this data in its unencrypted form, you can use an eBPF program attached to the right place in the user space code.</p>
<h3 id="8-5-1-User-Space-SSL-Libraries"><a href="#8-5-1-User-Space-SSL-Libraries" class="headerlink" title="8.5.1 User Space SSL Libraries"></a>8.5.1 User Space SSL Libraries</h3><p>An application using OpenSSL sends data to be encrypted by making a call to a function called <code>SSL_write()</code> and retrieves cleartext data that was received over the network in encrypted form using <code>SSL_read()</code>.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pixie-io/pixie-demos/tree/main/openssl-tracer">https://github.com/pixie-io/pixie-demos/tree/main/openssl-tracer</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">process_SSL_data</span><span class="params">(<span class="keyword">struct</span> pt_regs* ctx, <span class="type">uint64_t</span> id, <span class="keyword">enum</span> ssl_data_event_type type,</span></span><br><span class="line"><span class="params">                            <span class="type">const</span> <span class="type">char</span>* buf)</span> &#123;</span><br><span class="line">  <span class="type">int</span> len = (<span class="type">int</span>)PT_REGS_RC(ctx);</span><br><span class="line">  <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ssl_data_event_t</span>* <span class="title">event</span> =</span> create_ssl_data_event(id);</span><br><span class="line">  <span class="keyword">if</span> (event == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  event-&gt;type = type;</span><br><span class="line">  <span class="comment">// This is a max function, but it is written in such a way to keep older BPF verifiers happy.</span></span><br><span class="line">  event-&gt;data_len = (len &lt; MAX_DATA_SIZE ? (len &amp; (MAX_DATA_SIZE - <span class="number">1</span>)) : MAX_DATA_SIZE);</span><br><span class="line">  bpf_probe_read(event-&gt;data, event-&gt;data_len, buf);</span><br><span class="line">  tls_events.perf_submit(ctx, event, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <span class="type">ssl_data_event_t</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://binw666.github.io/learning-ebpf-translation/08-%E7%94%A8%E4%BA%8E%E7%BD%91%E7%BB%9C%E7%9A%84eBPF/figure-8-4.jpg"></p>
<h2 id="8-6-eBPF-and-Kubernetes-Networking"><a href="#8-6-eBPF-and-Kubernetes-Networking" class="headerlink" title="8.6 eBPF and Kubernetes Networking"></a>8.6 eBPF and Kubernetes Networking</h2><p>In Kubernetes environments, applications are deployed in pods. Each pod is a group of one or more containers that share kernel namespaces and cgroups, isolating pods from each other and from the host machine they are running on.</p>
<p><img src="https://binw666.github.io/learning-ebpf-translation/08-%E7%94%A8%E4%BA%8E%E7%BD%91%E7%BB%9C%E7%9A%84eBPF/figure-8-6.jpg"></p>
<p>eBPF enables replacing iptables and conntrack with a more efficient solution for managing network rules and connection tracking.</p>
<h3 id="8-6-1-Avoiding-iptables"><a href="#8-6-1-Avoiding-iptables" class="headerlink" title="8.6.1 Avoiding iptables"></a>8.6.1 Avoiding iptables</h3><p>pods – and their IP addresses – come and go dynamically, and each time a pod is added or removed, the iptables rules have to be rewritten in their entirety, and this impacts performance at scale.</p>
<p>Cilium uses eBPF hash table maps to store network policy rules, connection tracking, and load balancer lookup tables, which can replace iptables for kube-proxy. </p>
<h3 id="8-6-2-Coordinated-Network-Programs"><a href="#8-6-2-Coordinated-Network-Programs" class="headerlink" title="8.6.2 Coordinated Network Programs"></a>8.6.2 Coordinated Network Programs</h3><p>flat networking mode, in which Cilium allocates IP addresses for all the pods in a cluster from the same CIDR and directly routes traffic between them.</p>
<p>Different eBPF programs get invoked to handle traffic depending on whether a packet is destined for a local container, the local host, another host on this network, or a tunnel.</p>
<h3 id="8-6-3-Network-Policy-Enforcement"><a href="#8-6-3-Network-Policy-Enforcement" class="headerlink" title="8.6.3 Network Policy Enforcement"></a>8.6.3 Network Policy Enforcement</h3><p>Cilium uses Kubernetes identities to determine whether a given network policy rule applies. In the same way labels define which pods are part of a service in Kubernetes, labels also define Cilium’s security identity for the pod. eBPF hash tables, indexed by these service identities, make for very efficient rule lookups.</p>
<h3 id="8-6-4-Encrypted-Connections"><a href="#8-6-4-Encrypted-Connections" class="headerlink" title="8.6.4 Encrypted Connections"></a>8.6.4 Encrypted Connections</h3><p>transparent encryption. It’s called “transparent” because it takes place entirely at the network layer.</p>
<p>There are two in-kernel encryption protocols in common usage, IPsec and WireGuard.</p>
<p>they set up a secure tunnel between two machines. The CNI can choose to connect the eBPF endpoint for a pod via this secure tunnel.</p>
<p>eBPF is now enabling a new approach that builds on transparent encryption but uses TLS for the initial certificate exchange and endpoint authentication so that the identities can represent individual applications rather than the nodes they are running on.</p>
<h2 id="8-7-Summary"><a href="#8-7-Summary" class="headerlink" title="8.7 Summary"></a>8.7 Summary</h2><div class="tag-plugin colorful checkbox" ><input type="checkbox"/><span>todo</span></div>

<h2 id="8-8-Exercises-and-Further-Reading"><a href="#8-8-Exercises-and-Further-Reading" class="headerlink" title="8.8 Exercises and Further Reading"></a>8.8 Exercises and Further Reading</h2><div class="tag-plugin colorful checkbox" ><input type="checkbox"/><span>todo</span></div></article>
<div class="article-footer">
    <section id="references">
      <div class="header"><span>参考资料</span></div>
      <div class="body">
        <ul>
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=L3_AOFSNKK8">A Load Balancer from scratch</a></p>

        </li>
        
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/reference-guides/bpf/index.html#program-types">BPF and XDP Reference Guide</a></p>

        </li>
        
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/cilium-life-of-a-packet-pod-to-service-zh/">Life of a Packet in Cilium：实地探索 Pod-to-Service 转发路径及 BPF 处理逻辑</a></p>

        </li>
        </ul>
      </div>
    </section>
    

</div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/ebpf/learning-ebpf-07/">07. eBPF Program and Attachment Types</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/ebpf/learning-ebpf-09/">09. eBPF for Security</a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" src="https://giscus.app/client.js" data-repo="gaoyangu/blog_giscus" data-repo-id="R_kgDOQQ_jlg" data-category="Announcements" data-category-id="DIC_kwDOQQ_jls4CxiD3" data-mapping="url" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">gaoyangu</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-Packet-Drops"><span class="toc-text">8.1 Packet Drops</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1-XDP-Program-Return-Codes"><span class="toc-text">8.1.1 XDP Program Return Codes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-2-XDP-Packet-Parsing"><span class="toc-text">8.1.2 XDP Packet Parsing</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hello-ping"><span class="toc-text">hello ping</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-Load-Balancing-and-Forwarding"><span class="toc-text">8.2 Load Balancing and Forwarding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-XDP-Offloading"><span class="toc-text">8.3 XDP Offloading</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-Traic-Control-TC"><span class="toc-text">8.4 Traic Control (TC)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5-Packet-Encryption-and-Decryption"><span class="toc-text">8.5 Packet Encryption and Decryption</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-1-User-Space-SSL-Libraries"><span class="toc-text">8.5.1 User Space SSL Libraries</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-6-eBPF-and-Kubernetes-Networking"><span class="toc-text">8.6 eBPF and Kubernetes Networking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-1-Avoiding-iptables"><span class="toc-text">8.6.1 Avoiding iptables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-2-Coordinated-Network-Programs"><span class="toc-text">8.6.2 Coordinated Network Programs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-3-Network-Policy-Enforcement"><span class="toc-text">8.6.3 Network Policy Enforcement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-4-Encrypted-Connections"><span class="toc-text">8.6.4 Encrypted Connections</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-7-Summary"><span class="toc-text">8.7 Summary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-8-Exercises-and-Further-Reading"><span class="toc-text">8.8 Exercises and Further Reading</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":null,"officialHosts":["localhost"],"encoded":""};
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, false);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
